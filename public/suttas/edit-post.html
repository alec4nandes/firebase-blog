<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Document</title>
        <style>
            form {
                width: 300px;
                display: flex;
                flex-direction: column;
                gap: 5px;
                margin: auto;
            }

            form label {
                display: flex;
                gap: 5px;
            }

            form label input {
                flex: 1;
            }

            .highlighted {
                background-color: yellowgreen;
            }

            .highlighted .note-display {
                color: red;
                display: none;
                font-style: italic;
            }

            .highlighted:hover {
                background-color: yellow;
                cursor: pointer;
            }

            .highlighted:hover .note-display {
                display: inline;
            }
        </style>
    </head>
    <body>
        <form id="find-sutta">
            <label>sutta: <input name="sutta" type="text" /></label>
            <button type="submit">find sutta</button>
        </form>
        <div id="hidden-forms" style="display: none">
            <hr />
            <form id="highlight">
                <div id="lines"></div>
                <textarea name="note"></textarea>
                <button type="submit">annotate</button>
            </form>
            <hr />
            <form id="edit-post">
                <label>title: <input name="title" type="text" /></label>
                <label>subtitle: <input name="subtitle" type="text" /></label>
                <label>image url: <input name="image_url" type="text" /></label>
                <label>content: <input name="content" type="text" /></label>
                <button type="submit">edit post</button>
            </form>
        </div>

        <script type="module">
            import { getSutta } from "./sutta.js";

            const findSutta = document.querySelector("#find-sutta"),
                editPost = document.querySelector("#edit-post");

            findSutta.onsubmit = handleFindSutta;
            editPost.onsubmit = handleEditPost;

            let postSutta = {};

            async function handleFindSutta(e) {
                e.preventDefault();
                const suttaId = e.target.sutta.value,
                    hiddenForms = document.querySelector("#hidden-forms"),
                    highlight = hiddenForms.querySelector("#highlight"),
                    lines = highlight.querySelector("#lines");
                postSutta = await getSutta(suttaId);
                highlight.onsubmit = (e) => handleAnnotate(e, postSutta);
                lines.innerHTML = postSutta.display.linesHTML;
                hiddenForms.style.display = "block";

                function handleAnnotate(e, postSutta) {
                    e.preventDefault();
                    const note = e.target.note.value,
                        annotation = getAnnotation(postSutta, note);
                    if (annotation) {
                        postSutta.display.annotations =
                            postSutta.display.annotations.filter(
                                (oldAnn) => !isOverlapped(oldAnn, annotation)
                            );
                        postSutta.display.annotations.push(annotation);
                        highlightText(postSutta, lines);
                    }

                    function getAnnotation(postSutta, note) {
                        note = note.trim();
                        const { linesHTML } = postSutta.display,
                            text = getHighlighted();
                        return (
                            text &&
                            note && {
                                text,
                                // TODO/warning: might not always be the first occurrence
                                start: linesHTML.indexOf(text),
                                note,
                            }
                        );

                        /*
                            returns string
                        */
                        function getHighlighted() {
                            const selected =
                                window.getSelection?.() ||
                                document.getSelection?.() ||
                                document.selection?.createRange().text;
                            return selected
                                ?.toString()
                                .trim()
                                .replaceAll("\n", "<br/>");
                            // .replaceAll("\r", "");
                        }
                    }

                    // if you highlight an already highlighted section
                    function isOverlapped(oldAnnotation, newAnnotation) {
                        const { text: oldText, start: oldStart } =
                                oldAnnotation,
                            { text: newText, start: newStart } = newAnnotation;
                        return (
                            (oldStart <= newStart &&
                                newStart <= oldStart + oldText.length) ||
                            (newStart <= oldStart &&
                                oldStart + oldText.length <=
                                    newStart + newText.length)
                        );
                    }
                }
            }

            function highlightText(postSutta, lines) {
                const { annotations } = postSutta.display;
                let { linesHTML } = postSutta.display;
                console.log(annotations);
                let extraStart = 0;
                annotations.sort((a, b) => a.start - b.start);
                annotations.forEach(({ text, start, note }, i) => {
                    start += extraStart;
                    const spanOpenTag = `<span id="index-${i}" class="highlighted">`,
                        spanCloseTag = `
                                <small class="note-display">${note}</small>
                            </span>
                        `;
                    extraStart += spanOpenTag.length + spanCloseTag.length;
                    linesHTML = [...linesHTML];
                    linesHTML.splice(
                        start,
                        text.length,
                        `${spanOpenTag}${text}${spanCloseTag}`
                    );
                    linesHTML = linesHTML.join("");
                });
                lines.innerHTML = linesHTML;
            }

            // TODO: postSutta to new Firebase "drafts" db
            async function handleEditPost(e) {
                e.preventDefault();
                const post = Object.fromEntries(new FormData(e.target)),
                    upload = { sutta: postSutta, post };
                console.log(upload);
            }
        </script>
    </body>
</html>
