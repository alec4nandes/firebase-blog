<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Moon-Sun-Tides API &mdash; Alec Fernandes</title>
    </head>
    <body>
        <p>
            APIs USED: lune (npm), https://api.tidesandcurrents.noaa.gov,
            https://api.sunrise-sunset.org
        </p>
        <p>
            sample:
            https://fern.haus/moon-sun-tides-api/?latitude=34.0488&longitude=-118.2518&date=2022-11-30&time=04:32:09
        </p>
        <p>date and time are UTC, not relative to time zone</p>
        <form>
            <div>local time: <input type="datetime-local" /></div>
            <div>UTC time: <span id="datetime"></span></div>
            <div id="map" style="height: 300px; width: 100%"></div>
            <div>latitude: <span id="latitude"></span></div>
            <div>longitude: <span id="longitude"></span></div>
            <button type="submit">lookup</button>
        </form>

        <button id="local-info-button">or get your local info</button>

        <pre id="raw-text"></pre>

        <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCRNOo4f2HeGYjzA3zF9yu3Orx_Vc-YBLE"></script>

        <script type="module">
            import makeMap, { initialPos, setLatLngElems } from "./map.js";

            const latElem = document.getElementById("latitude"),
                lngElem = document.getElementById("longitude"),
                dateElem = document.getElementById("datetime"),
                dateInput = document.querySelector(
                    "input[type='datetime-local']"
                ),
                rawTextElem = document.getElementById("raw-text"),
                map = makeMap(latElem, lngElem);

            setLatLngElems(latElem, lngElem, initialPos.lat, initialPos.lng);

            document.querySelector("form").onsubmit = async (event) => {
                event.preventDefault();
                rawTextElem.innerHTML = "Compiling data...";
                rawTextElem.scrollIntoView({ behavior: "smooth" });
                try {
                    const lat = latElem.innerHTML,
                        lng = lngElem.innerHTML,
                        [date, time] = dateElem.innerHTML.split("T"),
                        url = `/moon-sun-tides-api/?latitude=${lat}&longitude=${lng}&date=${date}&time=${time}`,
                        resp = await fetch(url),
                        data = await resp.json();
                    displayRawText(data);
                } catch (error) {
                    rawTextElem.innerHTML = `ERROR: ${error.message}`;
                }
            };

            function displayRawText(data) {
                rawTextElem.innerHTML = JSON.stringify(data, null, 4);
                rawTextElem.scrollIntoView({ behavior: "smooth" });
            }

            document.getElementById("local-info-button").onclick = () => {
                rawTextElem.innerHTML = "Compiling data...";
                navigator.geolocation.getCurrentPosition(
                    async (pos) => {
                        const { latitude: lat, longitude: lng } = pos.coords;
                        setLatLngElems(latElem, lngElem, lat, lng);
                        dateElem.innerHTML = formatUTCDateTime(new Date());
                        dateInput.value = formatDateTime(new Date());
                        map.setCenter({ lat, lng });
                        const url = `/moon-sun-tides-api/?latitude=${lat}&longitude=${lng}`,
                            resp = await fetch(url),
                            data = await resp.json();
                        displayRawText(data);
                    },
                    (error) =>
                        (rawTextElem.innerHTML = `ERROR: ${error.message}`)
                );
            };

            // DATE:

            function formatUTCDateTime(date) {
                const pad = (num) => ("" + num).padStart(2, "0"),
                    year = date.getUTCFullYear(),
                    month = pad(date.getUTCMonth() + 1),
                    day = pad(date.getUTCDate()),
                    hours = pad(date.getUTCHours()),
                    minutes = pad(date.getMinutes());
                return `${year}-${month}-${day}T${hours}:${minutes}`;
            }

            function formatDateTime(date) {
                const pad = (num) => ("" + num).padStart(2, "0"),
                    year = date.getFullYear(),
                    month = pad(date.getMonth() + 1),
                    day = pad(date.getDate()),
                    hours = pad(date.getHours()),
                    minutes = pad(date.getMinutes());
                return `${year}-${month}-${day}T${hours}:${minutes}`;
            }

            dateElem.innerHTML = formatUTCDateTime(new Date());
            dateInput.value = formatDateTime(new Date());

            dateInput.onchange = (event) =>
                (dateElem.innerHTML = formatUTCDateTime(
                    new Date(event.target.value)
                ));
        </script>
    </body>
</html>
